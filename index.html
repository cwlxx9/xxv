# ============================================================
# ‚öôÔ∏è PowerShell 5 ‚Üí PowerShell 7 Bootstrap Loader (IRM-Safe)
# ============================================================

# --- Step 0 : Always download latest copy to temp and relaunch ---
if (-not $PSCommandPath) {
    $SourceUrl = 'https://cwlxxx.github.io/xxx'      # this same script URL
    $TempFile  = Join-Path $env:TEMP 'bootstrap-temp.ps1'

    Write-Host "üì• Downloading latest bootstrap script..."
    Invoke-WebRequest -Uri $SourceUrl -OutFile $TempFile -UseBasicParsing -Force

    Write-Host "üîÅ Launching downloaded script..."
    Start-Process powershell.exe "-ExecutionPolicy Bypass -File `"$TempFile`"" -Verb RunAs
    exit
}

# --- Step 1 : Ensure Administrator ---
$IsAdmin = ([Security.Principal.WindowsPrincipal] `
    [Security.Principal.WindowsIdentity]::GetCurrent() `
).IsInRole([Security.Principal.WindowsBuiltInRole] "Administrator")

if (-not $IsAdmin) {
    Write-Host "‚ö†Ô∏è  Restarting as Administrator..."
    Start-Process powershell.exe "-ExecutionPolicy Bypass -File `"$PSCommandPath`"" -Verb RunAs
    exit
}

Write-Host "‚úÖ Running as Administrator."

# --- Step 2 : Check / Install PowerShell 7 ---
$pwshPath = (Get-Command pwsh.exe -ErrorAction SilentlyContinue).Source
if (-not $pwshPath) {
    Write-Host "‚öôÔ∏è  Installing PowerShell 7..."
    if (-not (Get-Command winget.exe -ErrorAction SilentlyContinue)) {
        Write-Host "‚ùå  Windows Package Manager (winget) not found. Aborting."
        exit 1
    }

    # Install silently and display progress only
    Start-Process winget -ArgumentList 'install --id Microsoft.PowerShell --source winget --accept-source-agreements --accept-package-agreements --silent' -Wait
    $pwshPath = (Get-Command pwsh.exe -ErrorAction SilentlyContinue).Source

    if (-not $pwshPath) {
        Write-Host "‚ùå  PowerShell 7 installation failed."
        exit 1
    }
}

Write-Host "‚úÖ PowerShell 7 located at: $pwshPath"

# --- Step 3 : Launch Remote Script using PowerShell 7 ---
$RemoteScript = 'https://raw.githubusercontent.com/cwlxxx/vault7/refs/heads/main/Menu-NoGUI.ps1'
Write-Host "üöÄ Launching Menu-NoGUI.ps1 in PowerShell 7..."

Start-Process -FilePath $pwshPath -ArgumentList "-NoProfile -ExecutionPolicy Bypass -Command `"irm $RemoteScript | iex`""

# --- Step 4 : Clean up and exit ---
Write-Host "üßπ Cleaning up temporary file..."
Remove-Item -Path $PSCommandPath -Force -ErrorAction SilentlyContinue

Write-Host "‚úÖ Task complete. Closing PowerShell 5..."
Start-Sleep -Seconds 2
exit
