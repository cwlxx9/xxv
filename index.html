# ============================================================
# ‚öôÔ∏è PowerShell 5 Bootstrapper - Fixed Admin Relaunch
# ============================================================

# Step 1: Check admin rights
$IsAdmin = ([Security.Principal.WindowsPrincipal] [Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole] "Administrator")

if (-not $IsAdmin) {
    Write-Host "‚ö†Ô∏è  Not running as Administrator. Restarting as admin..."

    # If script was run via irm | iex, $PSCommandPath is null
    if (-not $PSCommandPath) {
        $TempFile = "$env:TEMP\bootstrap-temp.ps1"
        Write-Host "üìÅ Saving temp script to: $TempFile"
        (Invoke-WebRequest -Uri "https://raw.githubusercontent.com/cwlxxx/vault7/refs/heads/main/Menu-NoGUI.ps1" -UseBasicParsing).Content | Out-File -Encoding UTF8 $TempFile
        Start-Process powershell.exe "-ExecutionPolicy Bypass -File `"$TempFile`"" -Verb RunAs
        exit
    }

    # Normal file execution case
    Start-Process powershell.exe "-ExecutionPolicy Bypass -File `"$PSCommandPath`"" -Verb RunAs
    exit
}

Write-Host "‚úÖ Running as Administrator"

# Step 2: Check for PowerShell 7
$pwshPath = (Get-Command pwsh.exe -ErrorAction SilentlyContinue).Source
if (-not $pwshPath) {
    Write-Host "‚öôÔ∏è Installing PowerShell 7 via winget..."
    Start-Process winget -ArgumentList 'install --id Microsoft.PowerShell --source winget --accept-source-agreements --accept-package-agreements' -Wait
    $pwshPath = (Get-Command pwsh.exe -ErrorAction SilentlyContinue).Source
    if (-not $pwshPath) { Write-Host "‚ùå Install failed"; exit 1 }
}

# Step 3: Run script
Write-Host "üöÄ Running Menu-NoGUI.ps1 using PowerShell 7..."
Start-Process $pwshPath -ArgumentList '-NoProfile -ExecutionPolicy Bypass -Command "irm https://raw.githubusercontent.com/cwlxxx/vault7/refs/heads/main/Menu-NoGUI.ps1 | iex"'
