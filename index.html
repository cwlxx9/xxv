# ============================================================
# üöÄ PowerShell Smart Launcher (Final Stable Version)
# ‚úÖ Works on PowerShell 5 ‚Äì Ensures Admin Rights + Installs PS7 + Runs Liang Menu
# ============================================================

# URL of your PowerShell 7 script
$RemoteScriptUri = "https://raw.githubusercontent.com/cwlxxx/vault7/refs/heads/main/Menu-NoGUI.ps1"

# ------------------------------------------------------------
# üß© Section : Helper Functions - Start
# ------------------------------------------------------------

function Test-IsAdmin {
    $currentUser = [Security.Principal.WindowsIdentity]::GetCurrent()
    $principal = New-Object Security.Principal.WindowsPrincipal($currentUser)
    return $principal.IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)
}

function Get-PwshPath {
    $paths = @(
        "$env:ProgramFiles\PowerShell\7\pwsh.exe",
        "$env:ProgramFiles(x86)\PowerShell\7\pwsh.exe"
    )
    foreach ($p in $paths) {
        if (Test-Path $p) { return $p }
    }

    $fromPath = (Get-Command pwsh -ErrorAction SilentlyContinue)
    if ($fromPath) { return $fromPath.Source }

    return $null
}

function Install-PowerShell7 {
    Write-Host "`nPowerShell 7 not found. Installing silently via winget..." -ForegroundColor Yellow

    if (-not (Get-Command winget -ErrorAction SilentlyContinue)) {
        Write-Host "‚ùå 'winget' not available. Please install App Installer from Microsoft Store." -ForegroundColor Red
        exit 1
    }

    try {
        Start-Process -FilePath "winget" -ArgumentList @(
            "install",
            "--id", "Microsoft.PowerShell",
            "--source", "winget",
            "--accept-package-agreements",
            "--accept-source-agreements",
            "--silent"
        ) -Wait -NoNewWindow
    }
    catch {
        Write-Host "‚ùå Winget installation failed: $_" -ForegroundColor Red
        exit 1
    }

    Write-Host "`n‚úÖ PowerShell 7 installation completed. Verifying..." -ForegroundColor Green
    Start-Sleep -Seconds 3
}

# ------------------------------------------------------------
# üß© Section : Helper Functions - End
# ------------------------------------------------------------


# ------------------------------------------------------------
# üß† Section : Admin Elevation Check - Start (Fully Safe)
# ------------------------------------------------------------

if (-not (Test-IsAdmin)) {
    Write-Host "`nüîí Administrator rights required. Relaunching PowerShell 5 as Admin..." -ForegroundColor Yellow

    try {
        # Attempt to get the real file path
        $scriptDef = $MyInvocation.MyCommand.Definition
        $isFile = Test-Path $scriptDef

        if ($isFile) {
            # Running from a .ps1 file
            $scriptPath = (Resolve-Path -Path $scriptDef).Path
            Start-Process -FilePath "powershell.exe" -ArgumentList "-NoProfile -ExecutionPolicy Bypass -File `"$scriptPath`"" -Verb RunAs
        }
        else {
            # Running from memory (irm | iex)
            $launchCmd = "iex (irm '$($MyInvocation.MyCommand.Source)' -UseBasicParsing)"
            Start-Process -FilePath "powershell.exe" -ArgumentList "-NoProfile -ExecutionPolicy Bypass -Command `$launchCmd" -Verb RunAs
        }
    }
    catch {
        Write-Host "‚ùå Failed to elevate: $_" -ForegroundColor Red
    }

    exit 0
}

# ------------------------------------------------------------
# üß† Section : Admin Elevation Check - End
# ------------------------------------------------------------


# ------------------------------------------------------------
# ‚öôÔ∏è Section : PowerShell 7 Detection & Installation - Start
# ------------------------------------------------------------

$pwshPath = Get-PwshPath

if (-not $pwshPath) {
    Install-PowerShell7
    $pwshPath = Get-PwshPath
    if (-not $pwshPath) {
        Write-Host "‚ùå PowerShell 7 installation failed or not found." -ForegroundColor Red
        exit 1
    }
}

# ------------------------------------------------------------
# ‚öôÔ∏è Section : PowerShell 7 Detection & Installation - End
# ------------------------------------------------------------


# ------------------------------------------------------------
# üöÄ Section : Run Liang Menu in PowerShell 7 - Start
# ------------------------------------------------------------

$remoteCommand = @"
iex (Invoke-RestMethod -Uri '$RemoteScriptUri')
"@

$pwshArgs = @(
    '-NoProfile',
    '-ExecutionPolicy', 'Bypass',
    '-Command', $remoteCommand
)

Write-Host "`n‚úÖ Launching Menu-NoGUI.ps1 in PowerShell 7..." -ForegroundColor Green
Start-Process -FilePath $pwshPath -ArgumentList $pwshArgs -WindowStyle Normal | Out-Null

Start-Sleep -Seconds 2
exit 0

# ------------------------------------------------------------
# üöÄ Section : Run Liang Menu in PowerShell 7 - End
# ------------------------------------------------------------
