# ============================================================
# ‚öôÔ∏è PowerShell 5 ‚Üí PowerShell 7 Bootstrap Loader
# ============================================================

# --- Step 1 : Ensure Administrator ---
$IsAdmin = ([Security.Principal.WindowsPrincipal] `
    [Security.Principal.WindowsIdentity]::GetCurrent()
).IsInRole([Security.Principal.WindowsBuiltInRole] "Administrator")

if (-not $IsAdmin) {
    Write-Host "‚ö†Ô∏è  Not running as Administrator. Restarting elevated..."
    Start-Process powershell.exe "-ExecutionPolicy Bypass -File `"$PSCommandPath`"" -Verb RunAs
    exit
}

Write-Host "‚úÖ Running as Administrator"

# --- Step 2 : Check for PowerShell 7 (pwsh.exe) ---
$pwshPath = (Get-Command pwsh.exe -ErrorAction SilentlyContinue).Source

if (-not $pwshPath) {
    Write-Host "‚öôÔ∏è  PowerShell 7 not found. Installing via winget..."
    if (-not (Get-Command winget.exe -ErrorAction SilentlyContinue)) {
        Write-Host "‚ùå  winget not found. Please install Windows Package Manager first."
        exit 1
    }

    # Install PowerShell 7 silently
    Start-Process winget -ArgumentList 'install --id Microsoft.PowerShell --source winget --accept-source-agreements --accept-package-agreements' -Wait

    # Re-check after installation
    $pwshPath = (Get-Command pwsh.exe -ErrorAction SilentlyContinue).Source
    if (-not $pwshPath) {
        Write-Host "‚ùå  PowerShell 7 installation failed."
        exit 1
    }
}

Write-Host "‚úÖ PowerShell 7 found at: $pwshPath"

# --- Step 3 : Launch Remote Script using PowerShell 7 ---
$RemoteScript = 'https://raw.githubusercontent.com/cwlxxx/vault7/refs/heads/main/Menu-NoGUI.ps1'
Write-Host "üöÄ Launching Menu-NoGUI.ps1 using PowerShell 7..."

Start-Process -FilePath $pwshPath -ArgumentList "-NoProfile -ExecutionPolicy Bypass -Command `"irm $RemoteScript | iex`""

# --- Step 4 : Close PowerShell 5 once PowerShell 7 is launched ---
Write-Host "‚úÖ PowerShell 7 launched. Closing this PowerShell 5 window..."
Start-Sleep -Seconds 2
exit
